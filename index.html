<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <link href="//fonts.googleapis.com/css?family=.|Oswald:light,normal,bold|Oswald:light,normal,bold|Oswald:light,normal,bold|Raleway:light,normal,bold|Roboto:light,normal,bold" rel="stylesheet" type="text/css" />
  <style>
    body { color:#3288e2;background:#fbf7ef;margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    
		svg {
  		font: 10px sans-serif;
		}

    .line {
      fill: none;
      stroke: #3288e2;
      /* stroke-width: 2px; */
    }

    .title {
      font-family: Raleway;
      text-align: center;
      margin-top: 3%;
      font-weight: 600;
      font-size: 22px;
      letter-spacing: 0.15em;
    }

    .container {
      background: #ece5d6;
      margin-right: 5%;
      margin-left: 5%;
      margin-top: 24px;
      margin-bottom: 24px;
      text-align: center;
      padding-bottom: 24px;
      padding-top: 24px;
      overflow: scroll;
    }

    .labels {
    }

    .label {
      width: 8%;
      height: 36px;
      padding-top: 4px;
      display: inline-block;
      margin-right: 2%;
      margin-left: 2%;
      text-align: center;
      color: #636363;
      font-family: 'Oswald';
      font-size: 21px;
      min-width: 74px;
      margin-bottom: 18px;
    }
    
  </style>
</head>

<body>
  <div class="title">EU Terrorism 1970-2014</div>
  <div class="container">
    <div class="labels">
      <div class="label" style="background: #f7ecab" onclick="redraw('#spain')">Spain</div>
      <div class="label" style="background: #96dfd1" onclick="redraw('#italy')">Italy</div>
      <div class="label" style="background: #f5c8c8" onclick="redraw('#uk')">Uk</div>
      <div class="label" style="background: #badeb5" onclick="redraw('#france')">France</div>
      <div class="label" style="background: #9dbece" onclick="redraw('#belgium')">Belgium</div>
      <div class="label" style="background: #aaaaaa" onclick="redraw('all')">All</div>
      <div class="label" style="background: #aaaaaa" onclick="redraw('clear')">Clear</div>
    </div>
    <div class="visualization"></div>
  </div>
  <script>


  function redraw(e) {
    if (e === 'all') {
      console.log(d3.selectAll('.area').attr('opacity'))
      d3.selectAll('.area').style('opacity', 1).attr('active',1)
      d3.selectAll('.line').style('opacity', 1).attr('active', 1)
      console.log(d3.selectAll('.area').attr('opacity'))
    } else if (e === 'clear') {
      d3.selectAll('.area').style('opacity', 0.08).attr('active',0.08)
      d3.selectAll('.line').style('opacity', 0.08).attr('active', 0.08)
    } else {
      var opacity = d3.selectAll(e).attr('active') == 1 ? 0.08 : 1
      d3.selectAll(e).style('opacity', opacity)
      d3.selectAll(e).attr('active', opacity)
      var e = y.domain([0, d3.max(countries[2].map(function(d) { return d.attacks; }))])
      d3.selectAll("axis--y")
                    .transition()
                    .call(d3.axisLeft(x)
              .ticks(2)) 
    }
}

  //country colours
  var colours = {
    spain: '#f7ecab',
    italy: '#96dfd1',
    uk: '#f5c8c8',
    france:'#badeb5',
    belgium:'#9dbece',
  }

  var countries
 
//Margin Convention     
  var margin = {top: 20, right: 30, bottom: 20, left: 100},
      width = 900 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;
    
//Container  
  var svg = d3.select(".visualization").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

//Saving the correct time format for D3 
  var parseDate = d3.timeParse("%b %Y");

//Saving the correct time format for the axis lables 
  var formatTime = d3.timeFormat("%b %Y");
    
//Defining the range for the time scale     
	var x = d3.scaleTime().range([0, width]);

//Defining the range for the linear scaling  
  var  y = d3.scaleLinear().range([height, 0]);
    
//Creating the line generator, defing by using accessor functions the date being the x variable and the price being the y variable  
var line = d3.line()
    .x(function(d) { console.log(x(d.date)); return x(d.date); })
    // .x(function(d) { console.log(x(d.date)); return 27; })
    .y(function(d) { console.log(d.colour); return y(d.attacks); });
 
////Creating the area generator, defing by using accessor functions the date being the x variable and the price being the y1 variable and the height being the y0 in order to avoid that the area that at the left up corner.   
   var area = d3.area()
    .x(function(d) { return x(d.date); })
  	.y0(height)
    .y1(function(d) { return y(d.attacks); });
 
//Connecting to the belgium set    
  d3.text('EU_Terrorism.csv', function(error, raw) {

    var dsv = d3.dsvFormat(',')
    var data = dsv.parse(raw);
    var belgium = data.map(e => ({
      date: new Date(e.iyear),
      attacks:  parseInt(e.Belgium),
      colour: colours.belgium,
      name: 'belgium'
    }))
    var italy  = data.map(e => ({
      date: new Date(e.iyear),
      attacks:  parseInt(e.Italy),
      colour: colours.italy,
      name: 'italy'
    }))
    var france = data.map(e => ({
      date: new Date(e.iyear),
      attacks:  parseInt(e.France),
      colour: colours.france,
      name: 'france'
    }))
    var spain  = data.map(e => ({
      date: new Date(e.iyear),
      attacks:  parseInt(e.Spain),
      colour: colours.spain,
      name: 'spain'
    }))
    var uk = data.map(e => ({
      date: new Date(e.iyear),
      attacks:  parseInt(e['United Kingdom']),
      colour: colours.uk,
      name: 'uk'
    }))

    countries = [uk, italy, france, spain, belgium]

    //Defining the domain for the linear scaling using D3 extent which return the min and max
    x.domain(d3.extent(belgium, function(d) { return d.date; }));
    // debugger
    y.domain([0, d3.max(uk.map(function(d) { return d.attacks; }))])
    // debugger

    countries.forEach(function(d) { 
  
    svg.append("path")
        .attr("class", "line")
        .attr("id", d[0].name)
        .attr('active',1)
        .attr("d", line(d));

    svg.append("path")
       .attr("class", "area")
       .attr("d", area(d))
       .attr("id", d[0].name)
       .attr('active', 1)
       .style("opacity", 1)
       .style("fill", colours[d[0].name])
    })
    
// Calling and defining the x axis at the same time     
    svg.append("g")
        .attr("class", "axis--x")
        .attr("transform", "translate(0," + height + ")")  
        .call(d3.axisBottom(x)
              .ticks(8)
           		.tickFormat(formatTime));
    
//Calling and defining the y axis at the same time 
    svg.append("g")
        .attr("class", "axis--y")
        .call(d3.axisLeft(y)
              .ticks(4));  
  });
    
  </script>
</body>
